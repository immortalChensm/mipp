<include file="Public/min-header"/>
<!-- <link href="__PUBLIC__/plugins/daterangepicker/daterangepicker-bs3.css" rel="stylesheet" type="text/css" />
<script src="__PUBLIC__/plugins/daterangepicker/moment.min.js" type="text/javascript"></script>
<script src="__PUBLIC__/plugins/daterangepicker/daterangepicker.js" type="text/javascript"></script> -->
<script src="__PUBLIC__/js/ajaxfileupload.js" type="text/javascript"></script>
<style>
.group-list li{list-style-type: none;float:left;width:180px;height:30px;}
.group-list li input{margin-right:5px;}
.col-sm-8 .image-contain{width:60%;}
.col-sm-8 .image-contain .image-div{width:120px;height:120px;border:1px solid #ccc;float:left;margin-right: 4px;margin-bottom: 4px;position:relative;}
.col-sm-8 .image-contain .image-div .delete-img{width:100%;height:30px;bottom:0;cursor:pointer;background:#000;opacity:0.6;line-height:30px;text-align:center;opacity: 0.5;position: absolute;color:#fff;display:none;}
.col-sm-8 .image-contain #image_btn{background:url(__PUBLIC__/Admin/images/default.png) no-repeat center;background-size:cover;cursor:pointer;}
.all_tags{width:80%;border:1px solid #ccc;border-radius:5px;padding:2px 8px;padding:5px 8px;min-height:50px;overflow:hidden;}
.all_tags span{float:left;padding:8px 12px !important;margin:3px 5px;}
.select_tags{width:80%;border:1px solid #ccc;border-radius:5px;padding:2px 8px;padding:5px 8px;min-height:50px;overflow:hidden;margin-top:10px;}
.select_tags span{float:left;padding:8px 12px !important;margin:3px 5px;}
</style>
<include file="Public/myeditor"/>
<script>
myeditor('content');
</script>
<div class="wrapper">
    <include file="Public/breadcrumb"/>
    <section class="content" style="padding:0px 15px;">
        <!-- Main content -->
        <div class="container-fluid">
            <div class="pull-right">
                <a href="javascript:history.go(-1)" data-toggle="tooltip" title="" class="btn btn-default" data-original-title="返回"><i class="fa fa-reply"></i></a>
            </div>
            <div class="panel panel-default">     
            	<div class="panel-heading">
                    <h3 class="panel-title"><i class="fa fa-list"></i> {:$info ? '编辑课程信息' : '添加课程'}</h3>
                </div>      
                <div class="panel-body ">   
                    <!--表单数据-->
                    <form method="post" id="dataForm" >
                    <input type="hidden" name="info[id]" value="{$info.id}"/>    
                    <input type="hidden" name="info[teacher_id]" value="{$info.teacher_id}"/>    
                    <!--通用信息-->
                    <div class="tab-content" style="padding:20px 0px;">
                        <div class="tab-pane active" id="tab_tongyong">
                            <table class="table table-bordered">
                                <tbody>
                                <tr>
                                    <td class="col-sm-2">课程名称：</td>
                                    <td class="col-sm-8">
                                        <input type="text" class="form-control" name="info[name]" value="{$info.name}" placeholder="请输入课程名称"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-sm-2">课程类型：</td>
                                    <td class="col-sm-8">
                                        <select class="form-control" name="info[type]">
                                            <option value="">请选择课程类型</option>
                                            <foreach name="types" item="val">
                                                <option value="{$key}" {:$info['type'] == $key ? 'selected' :''}>{$val}</option>
                                            </foreach>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-sm-2">课程价格：</td>
                                    <td class="col-sm-8">
                                        <input type="number" class="form-control" name="info[price]" value="{$info.price}" placeholder="请输入课程价格"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-sm-2">限购人数：</td>
                                    <td class="col-sm-8">
                                        <input type="number" class="form-control" name="info[stock]" value="{$info.stock}" placeholder="请输入限购人数"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-sm-2">课程图片：</td>
                                    <td class="col-sm-8">
										<div  class="image-contain" >
											<foreach name="info.pics" item="val">
											<div class="image-div" style="background:url({$val}) no-repeat center;background-size:contain;">
												<div class="delete-img">删除</div>
												<input type="hidden" name="info[pics][]" value="{$val}"/>
											</div>
											</foreach>
											<div class="image-div" id="image_btn" onclick="$(this).next('input[name=upimg]').click()"></div>
											<input type="file" id="upimg" name="upimg" onchange="upload_img(this.id)" style="display:none;"/>
										</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-sm-2">介绍视频：</td>
                                    <td class="col-sm-8">
                                        <input style="cursor:pointer" type="text" class="form-control" onclick="$(this).next().click()" readonly name="info[link]" value="{$info.link}" placeholder="点击上传视频，视频大小最大为10M">
                                        <input type="file" id="link" name="link" style="display:none;" onchange="upload_video(this.id)"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-sm-2">课程简介：</td>
                                    <td class="col-sm-8">
                                        <textarea style="resize:none;height:80px;"  class="form-control" name="info[profile]">{$info.profile}</textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-sm-2">课程标签：</td>
                                    <td class="col-sm-8">
                                        <div class="all_tags">
                                        	<foreach name="tags" item="val">
                                        	<span class="btn {:in_array($val,$info['tags'])? 'btn-primary' : 'btn-default'}">{$val}</span>
                                        	</foreach>
                                        </div>
                                        <div class="select_tags">
                                        	<foreach name="info.tags" item="val">
                                        	<span data-val="{$val}" class="btn btn-default">{$val}  <i class="fa fa-remove">
                                            </i><input type="hidden" name="info[tags][]" value="{$val}"/>
                                            </span>
                                        	</foreach>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-sm-2">课程详情：</td>
                                    <td width="85%" class="col-sm-8">
                                        <textarea class="span12 ckeditor" id="content" name="info[content]" title="">{$info.content}</textarea>
                                    </td>                                                                       
                                </tr>  
                                </tbody> 
                                <tfoot>
                                	<tr>
                                	<td><!-- <input type="hidden" name="inc_type" value="{$inc_type}"> --></td>
                                	<td class="text-right"><input class="btn btn-primary" type="button" onclick="save()" value="保存"></td></tr>
                                </tfoot>                               
                                </table>
                        </div>                           
                    </div>              
			    	</form><!--表单数据-->
                </div>
            </div>
        </div>
    </section>
</div>
<script type="text/plain" id="myEditor"></script>
<script type="text/plain" id="upload_ue"></script>
<script>
//重新实例化一个编辑器，防止在上面的editor编辑器中显示上传的图片或者文件
var _editor = UE.getEditor('upload_ue');
_editor.ready(function () {
    //设置编辑器不可用
    _editor.setDisabled();
    //隐藏编辑器，因为不会用到这个编辑器实例，所以要隐藏
    _editor.hide();
    //侦听图片上传
    _editor.addListener('beforeInsertImage', function (t, arg) {
        //将地址赋值给相应的input,只去第一张图片的路径
        $("#picture").attr("value", arg[0].src);
        //图片预览
        $("#preview").attr("src", arg[0].src);
    })
    //侦听文件上传，取上传文件列表中第一个上传的文件的路径
    _editor.addListener('afterUpfile', function (t, arg) {
        $("#file").attr("value", _editor.options.filePath + arg[0].url);
    })
});
//弹出图片上传的对话框
function upImage() {
    var myImage = _editor.getDialog("insertimage");
    myImage.open();
}
//弹出文件上传的对话框
function upFiles() {
    var myFiles = _editor.getDialog("attachment");
    myFiles.open();
}
//弹出视频上传的对话框
function upVideos() {
    var myFiles = _editor.getDialog("insertvideo");
    myFiles.open();
}
</script> 
<script>
$(function(){
	$('.image-contain').on('mouseenter','.image-div',function(){
		$(this).find('.delete-img').show();
	})
	$('.image-contain').on('mouseleave','.image-div',function(){
		$(this).find('.delete-img').hide();
	})
	$('.image-contain').on('click','.image-div>.delete-img',function(){
		$(this).parent().remove();
	})
	
	$('.all_tags>span').click(function(){
		if($(this).hasClass('btn-default')){
            if($('.select_tags span').length >=3) {
                jsalert('课程最多添加3个标签',2);
                return false;
            }
			var tag = $(this).text();
			$('.select_tags').append('<span data-val="'+tag+'" class="btn btn-default">'+tag+'  <i class="fa fa-remove"></i><input type="hidden" name="info[tags][]" value="'+tag+'"/></span>');
			$(this).removeClass('btn-default').addClass('btn-primary')
		}else{
			jsalert('该标签已选中',2);
		}
	})
	$('.select_tags').on('click','span',function(){
		var tag = $(this).attr('data-val');
		$(this).remove();
		$('.all_tags>.btn-primary').each(function(){
			if(tag == $(this).text()){
				$(this).removeClass('btn-primary').addClass('btn-default')
			}
		})
	})
})
function upload_img(ele_id){
	upload(ele_id,function(data){
		if(data.status == '1'){
	 		$('#image_btn').before('<div class="image-div" name="course_pic" style="background:url('+data.info.image_url+') no-repeat center;background-size:contain;"><div class="delete-img">删除</div><input type="hidden" name="info[pics][]" value="'+data.info.image_url+'"/></div>');
	 	}else{
	 		jsalert(data.msg,2);
	 	}
	});
}

function upload_video(ele_id){
    var layind = jsloading();
	upload_vdo(ele_id,function(data){
        //console.log(data.info)
        layer.close(layind)
		if(data.status == '1'){
	 		$('#'+ele_id).prev('input').val(data.info.video_url);
	 	}else{
	 		jsalert(data.msg,2);
	 	}
	});
}
function save(){
	$.post("{:U('Course/edit')}",$('#dataForm').serializeArray(),function(data){
		if(data.status == '1'){
			jsalert(data.info,1,function(){
				location.href = data.url;
			});
		}else{
			jsalert(data.info,2);
		}
	});
}
</script>
</body>
</html>